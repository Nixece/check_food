import streamlit as st
from PIL import Image
import numpy as np
import pandas as pd
import cv2
import os

# à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸£à¸µà¹€à¸‹à¹‡à¸•à¸„à¸°à¹à¸™à¸™ (à¸¥à¸šà¹„à¸Ÿà¸¥à¹Œ scores.csv)
def reset_scores():
    if os.path.exists('scores.csv'):
        os.remove('scores.csv')
        st.write("à¸„à¸°à¹à¸™à¸™à¸ªà¸°à¸ªà¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸–à¸¹à¸à¸£à¸µà¹€à¸‹à¹‡à¸•à¹à¸¥à¹‰à¸§!")

# à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹à¸›à¸¥à¸‡à¸ à¸²à¸à¹€à¸›à¹‡à¸™à¸£à¸¹à¸›à¹à¸šà¸šà¸ªà¸µ HSV à¹€à¸à¸·à¹ˆà¸­à¹ƒà¸Šà¹‰à¹ƒà¸™à¸à¸²à¸£à¸•à¸£à¸§à¸ˆà¸ˆà¸±à¸šà¸ªà¸µà¸—à¸µà¹ˆà¸„à¸¥à¹‰à¸²à¸¢à¸­à¸²à¸«à¸²à¸£
def is_food_basic(image):
    # à¹à¸›à¸¥à¸‡à¸ à¸²à¸à¹€à¸›à¹‡à¸™à¸ªà¸µ HSV
    img_array = np.array(image)
    hsv_image = cv2.cvtColor(img_array, cv2.COLOR_RGB2HSV)
    
    # à¸à¸³à¸«à¸™à¸”à¸‚à¸­à¸šà¹€à¸‚à¸•à¸‚à¸­à¸‡à¸ªà¸µà¸—à¸µà¹ˆà¸à¸šà¸šà¹ˆà¸­à¸¢à¹ƒà¸™à¸­à¸²à¸«à¸²à¸£ (à¹€à¸Šà¹ˆà¸™ à¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥, à¸ªà¸µà¸‚à¸²à¸§)
    lower_brown = np.array([10, 50, 20])  # à¸‚à¸­à¸šà¹€à¸‚à¸•à¸¥à¹ˆà¸²à¸‡à¸‚à¸­à¸‡à¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥
    upper_brown = np.array([20, 255, 200])  # à¸‚à¸­à¸šà¹€à¸‚à¸•à¸šà¸™à¸‚à¸­à¸‡à¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥

    lower_white = np.array([0, 0, 200])  # à¸‚à¸­à¸šà¹€à¸‚à¸•à¸¥à¹ˆà¸²à¸‡à¸‚à¸­à¸‡à¸ªà¸µà¸‚à¸²à¸§
    upper_white = np.array([180, 30, 255])  # à¸‚à¸­à¸šà¹€à¸‚à¸•à¸šà¸™à¸‚à¸­à¸‡à¸ªà¸µà¸‚à¸²à¸§
    
    # à¸ªà¸£à¹‰à¸²à¸‡ mask à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¸µà¸™à¹‰à¸³à¸•à¸²à¸¥à¹à¸¥à¸°à¸ªà¸µà¸‚à¸²à¸§
    mask_brown = cv2.inRange(hsv_image, lower_brown, upper_brown)
    mask_white = cv2.inRange(hsv_image, lower_white, upper_white)
    
    # à¸£à¸§à¸¡ mask à¸—à¸±à¹‰à¸‡à¸ªà¸­à¸‡à¹€à¸‚à¹‰à¸²à¸”à¹‰à¸§à¸¢à¸à¸±à¸™
    combined_mask = cv2.bitwise_or(mask_brown, mask_white)
    
    # à¸„à¸³à¸™à¸§à¸“à¸ˆà¸³à¸™à¸§à¸™à¸à¸´à¸à¹€à¸‹à¸¥à¸—à¸µà¹ˆà¸•à¸£à¸‡à¸à¸±à¸šà¸ªà¸µà¸‚à¸²à¸§à¸«à¸£à¸·à¸­à¸™à¹‰à¸³à¸•à¸²à¸¥
    food_pixels = cv2.countNonZero(combined_mask)
    
    # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸‚à¸­à¸‡à¸à¸´à¸à¹€à¸‹à¸¥à¸­à¸²à¸«à¸²à¸£à¸à¸±à¸šà¸à¸´à¸à¹€à¸‹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹ƒà¸™à¸ à¸²à¸
    total_pixels = img_array.shape[0] * img_array.shape[1]
    food_ratio = food_pixels / total_pixels
    
    # à¸–à¹‰à¸²à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸à¸´à¸à¹€à¸‹à¸¥à¸­à¸²à¸«à¸²à¸£à¸¡à¸²à¸à¸à¸§à¹ˆà¸² 10% à¸–à¸·à¸­à¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸ à¸²à¸à¸­à¸²à¸«à¸²à¸£
    if food_ratio > 0.1:
        return True
    return False

# à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸à¸²à¸£à¸„à¸³à¸™à¸§à¸“à¸„à¸°à¹à¸™à¸™à¸ˆà¸²à¸à¸›à¸£à¸´à¸¡à¸²à¸“à¹€à¸¨à¸©à¸­à¸²à¸«à¸²à¸£à¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­à¹ƒà¸™à¸ˆà¸²à¸™
def calculate_waste(image):
    gray_image = image.convert("L")  # à¹à¸›à¸¥à¸‡à¸ à¸²à¸à¹€à¸›à¹‡à¸™à¸‚à¸²à¸§à¸”à¸³
    img_array = np.array(gray_image)

    # à¹ƒà¸Šà¹‰à¸à¸²à¸£à¸—à¸³ Threshold à¹€à¸à¸·à¹ˆà¸­à¹à¸¢à¸à¹€à¸¨à¸©à¸­à¸²à¸«à¸²à¸£à¸­à¸­à¸à¸ˆà¸²à¸à¸à¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡
    _, threshold_image = cv2.threshold(img_array, 150, 255, cv2.THRESH_BINARY_INV)
    
    # à¸„à¹‰à¸™à¸«à¸² Contours
    contours, _ = cv2.findContours(threshold_image, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

    # à¸„à¸³à¸™à¸§à¸“à¸ˆà¸³à¸™à¸§à¸™à¸à¸´à¸à¹€à¸‹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹ƒà¸™à¸ à¸²à¸
    total_pixels = img_array.shape[0] * img_array.shape[1]
    
    # à¸„à¸³à¸™à¸§à¸“à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆà¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¹€à¸¨à¸©à¸­à¸²à¸«à¸²à¸£
    waste_pixels = sum(cv2.contourArea(c) for c in contours if cv2.contourArea(c) > 1000)

    # à¸„à¸³à¸™à¸§à¸“à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆà¹€à¸¨à¸©à¸­à¸²à¸«à¸²à¸£à¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­
    waste_ratio = waste_pixels / total_pixels
    
    # à¹ƒà¸«à¹‰à¸„à¸°à¹à¸™à¸™à¸•à¸²à¸¡à¸ªà¸±à¸”à¸ªà¹ˆà¸§à¸™à¹€à¸¨à¸©à¸­à¸²à¸«à¸²à¸£
    if waste_ratio > 0.5:
        return 0
    elif waste_ratio < 0.05:
        return 10
    return int((1 - waste_ratio) * 10)

# à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸„à¸°à¹à¸™à¸™
def save_score(student_id, score):
    if not os.path.exists('scores.csv'):
        df = pd.DataFrame(columns=['Student ID', 'Score'])
    else:
        df = pd.read_csv('scores.csv')
    
    new_entry = pd.DataFrame([{'Student ID': student_id, 'Score': score}])
    df = pd.concat([df, new_entry], ignore_index=True)
    st.write(f"à¹€à¸à¸´à¹ˆà¸¡à¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚ {student_id} à¸à¸£à¹‰à¸­à¸¡à¸„à¸°à¹à¸™à¸™: {score}")
    
    df.to_csv('scores.csv', index=False)

# à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹à¸ªà¸”à¸‡ 10 à¸„à¸™à¸¥à¹ˆà¸²à¸ªà¸¸à¸”
def show_latest_entries():
    if os.path.exists('scores.csv'):
        df = pd.read_csv('scores.csv')
        latest_10 = df.tail(10)
        st.write("ğŸ“‹ **10 à¸„à¸™à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥** ğŸ“‹")
        st.table(latest_10)
    else:
        st.write("à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸„à¸°à¹à¸™à¸™")

# à¸ªà¹ˆà¸§à¸™à¸‚à¸­à¸‡à¸à¸²à¸£à¹ƒà¸ªà¹ˆà¹€à¸¥à¸‚à¸›à¸£à¸°à¸ˆà¸³à¸•à¸±à¸§à¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²à¹à¸¥à¸°à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›
st.title('Food Waste LE02')
st.write("à¸à¸£à¸­à¸à¹€à¸¥à¸‚à¸›à¸£à¸°à¸ˆà¸³à¸•à¸±à¸§à¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²à¹à¸¥à¸°à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸ à¸²à¸à¸ˆà¸²à¸™à¸­à¸²à¸«à¸²à¸£à¹€à¸à¸·à¹ˆà¸­à¸£à¸±à¸šà¸„à¸°à¹à¸™à¸™")

# à¸›à¸¸à¹ˆà¸¡à¸£à¸µà¹€à¸‹à¹‡à¸•à¸„à¸°à¹à¸™à¸™
if st.button('à¸£à¸µà¹€à¸‹à¹‡à¸•à¸„à¸°à¹à¸™à¸™'):
    reset_scores()

# à¹ƒà¸ªà¹ˆà¹€à¸¥à¸‚à¸›à¸£à¸°à¸ˆà¸³à¸•à¸±à¸§à¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²
student_id = st.text_input("à¹ƒà¸ªà¹ˆà¹€à¸¥à¸‚à¸›à¸£à¸°à¸ˆà¸³à¸•à¸±à¸§à¸™à¸±à¸à¸¨à¸¶à¸à¸©à¸²")

# à¸ªà¹ˆà¸§à¸™à¸à¸²à¸£à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸£à¸¹à¸›à¸ à¸²à¸
uploaded_file = st.file_uploader("à¹€à¸¥à¸·à¸­à¸à¸ à¸²à¸à¸—à¸µà¹ˆà¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”", type=["jpg", "png", "jpeg"])

if uploaded_file is not None and student_id:
    image = Image.open(uploaded_file)
    
    st.image(image, caption="à¸ à¸²à¸à¸—à¸µà¹ˆà¸„à¸¸à¸“à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”", use_column_width=True)
    
    # à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¹€à¸›à¹‡à¸™à¸­à¸²à¸«à¸²à¸£à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
    if not is_food_basic(image):
        st.write("à¸à¸£à¸¸à¸“à¸²à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸ à¸²à¸à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸­à¸²à¸«à¸²à¸£à¹€à¸—à¹ˆà¸²à¸™à¸±à¹‰à¸™")
    else:
        # à¸„à¸³à¸™à¸§à¸“à¸„à¸°à¹à¸™à¸™
        score = calculate_waste(image)
        st.write(f"à¸„à¸°à¹à¸™à¸™à¸—à¸µà¹ˆà¹„à¸”à¹‰: {score} / 10")
        
        # à¸šà¸±à¸™à¸—à¸¶à¸à¸„à¸°à¹à¸™à¸™
        save_score(student_id, score)

# à¹à¸ªà¸”à¸‡ 10 à¸„à¸™à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
show_latest_entries()
